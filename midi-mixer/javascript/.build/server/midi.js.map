{"version":3,"names":["JZZ","_","log","str","onMidiOutFail","Error","onMidiInFail","getMidiDeviceList","info","globals","selectMidiOut","selectMidiIn","i","outputs","length","push","name","inputs","set","getNamesFromPage","activePage","names","returnArray","getValuesFromPage","faderUser","setMixerView","tracks","tracksId","map","t","get","sort","lastBankId","Math","ceil","forEach","track","absIndex","relIndex","displayName","displayUserFader","setFaderView","channel","faderBytes","onFaderMove","state","findIndex","e","find","value","undefined","source","_displayUserFader","displayValue","throttle"],"sources":["../../src/server/midi.js"],"sourcesContent":["import JZZ from 'jzz';\nimport _ from 'lodash';\n\nfunction log(str) {\n  //console.log(str);\n}\n\nexport function onMidiOutFail() {\n  throw new Error(\"> Error: fail opening midi out\");\n}\n\nexport function onMidiInFail() {\n  throw new Error(\"> Error: fail opening midi in\");\n}\n\nexport function getMidiDeviceList(info, globals) {\n  const selectMidiOut = [];\n  const selectMidiIn = [];\n  for (let i = 0; i < info.outputs.length; i++) {\n    selectMidiOut.push(info.outputs[i].name);\n    // selectMidiOut[i] = new Option(info.outputs[i].name);\n  }\n  for (let i = 0; i < info.inputs.length; i++) {\n    selectMidiIn.push(info.inputs[i].name);\n    // selectMidiIn[i] = new Option(info.inputs[i].name);\n  }\n  globals.set({ selectMidiIn: selectMidiIn });\n  globals.set({ selectMidiOut: selectMidiOut });\n}\n\n\nfunction getNamesFromPage(activePage, names) {\n  const returnArray = [];\n\n  for (let i = 0; i < names.length; i++) {\n    if (i > (activePage * 8) && i <= ((activePage + 1) * 8)) {\n        returnArray.push(names[i]);\n    }\n  };\n\n  return returnArray;\n}\n\nfunction getValuesFromPage(activePage, faderUser) {\n  const returnArray = [];\n\n  for (let i = 0; i < faderUser.length; i++) {\n    if (i > (activePage * 8) && i <= ((activePage + 1) * 8)) {\n        returnArray.push(faderUser[i]);\n    }\n  };\n  return returnArray;\n}\n\n// total update : 8 faders + 2 displays\nexport async function setMixerView(activePage, tracks) {\n  const tracksId = tracks.map(t => t.get('channel')).sort();\n  const lastBankId = Math.ceil((tracksId[tracksId.length - 1] / 8) * 8);\n\n  tracks.forEach(track => {\n    const absIndex = track.get('channel');\n    const relIndex = (absIndex - 1) % 8 + 1;\n\n    if (absIndex > (activePage * 8) && absIndex <= ((activePage + 1) * 8) && absIndex !== 0) {\n      if (track.get('channel') !== null) {\n        log(`> set fader CH${relIndex}: ${track.get('faderBytes')}`);\n      } else {\n        log(`> set fader CH${relIndex}: 0`);\n      }\n    }\n  });\n\n  // update display\n  const displayName = getNamesFromPage(activePage, tracks.map(t => t.get('name')));\n  log(`> names ${displayName}`);\n  displayUserFader(activePage, tracks);\n\n}\n\nexport function setFaderView(channel, activePage, tracks) {\n  // @todo send 'release' message when no moves\n  const relIndex = (channel - 1) % 8 + 1;\n  const faderBytes = tracks.map(t => t.get('faderBytes'))[channel]; // retrieve track value\n\n  if (relIndex + (activePage * 8) === channel) {\n    log(`> set fader CH${relIndex}: ${faderBytes}`);\n    displayUserFader(activePage, tracks);\n  } else if (channel === 0) {\n    log(`> set fader MAIN: ${faderBytes}`);\n  }\n}\n\nexport async function onFaderMove(name, state, activePage, tracks) {\n  const relIndex = ['CH1', 'CH2', 'CH3', 'CH4', 'CH5', 'CH6', 'CH7', 'CH8'].findIndex(e => e === name);\n  const absIndex = (relIndex !== -1) ? (relIndex + 1 + activePage * 8) : 0;\n  const track = tracks.find(t => t.get('channel') === absIndex);\n  let value = null;\n\n  // handle unmapped faders\n  if (track === undefined) {\n    log(`> set fader ${name}: 0`);\n    return 0;\n  }\n\n\n  if (typeof state === 'number') {\n    // this fader move is not a touch / release event\n    value = state;\n  } else {\n    // this fader move is a touch / release event\n    value = track.get('faderBytes');\n  };\n\n  if (track !== undefined) {\n    track.set({\n      faderBytes: value\n    }, { source: 'midi' });\n  };\n\n  if (state === 'release') {\n    // do something on release\n  } else if (state === 'touch') {\n    // do something on touch\n  }\n}\n\nfunction _displayUserFader(activePage, tracks) {\n  const displayValue = getValuesFromPage(activePage, tracks.map(t => t.get('faderUser')));\n  log(`> display dB: ${displayValue}`);\n}\n\nexport const displayUserFader = _.throttle(_displayUserFader, 50, { 'trailing': true });\n"],"mappings":"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"}
